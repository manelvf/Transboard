# frozen_string_literal: true

module Gem; def self.all_load_paths; []; end; end

# ============================================================================
# Internationalization Tasks
# ============================================================================
desc "Update pot/po files for translations"
task :updatepo do
  require 'gettext/tools'
  require 'gettext/haml_parser'
  puts "Updating translation files..."
  GetText.update_pofiles("transboard", Dir.glob("{lib,views}/**/*.{rb,haml}") << "transboard.rb", "transboard 1.0.0", po_root: 'locale')
end

# ============================================================================
# Dependency Management Tasks
# ============================================================================
namespace :deps do
  desc "Install all dependencies"
  task :install do
    puts "Installing dependencies..."
    sh "bundle install"
  end

  desc "Update dependencies (respecting version constraints)"
  task :update do
    puts "Updating dependencies..."
    sh "bundle update"
  end

  desc "Check for outdated dependencies"
  task :outdated do
    puts "Checking for outdated dependencies..."
    sh "bundle outdated"
  end

  desc "Run security audit on dependencies"
  task :audit do
    puts "Running security audit..."
    begin
      require 'bundler/audit/task'
      Bundler::Audit::Task.new
      Rake::Task['bundle:audit'].invoke
    rescue LoadError
      puts "Installing bundler-audit..."
      sh "bundle exec bundle-audit check --update"
    end
  end

  desc "Clean unused dependencies"
  task :clean do
    puts "Cleaning unused dependencies..."
    sh "bundle clean"
  end

  desc "Show dependency tree"
  task :tree do
    puts "Dependency tree:"
    sh "bundle viz --format=png --file=doc/dependencies" rescue nil
    sh "bundle list"
  end
end

# ============================================================================
# Code Quality Tasks
# ============================================================================
namespace :lint do
  desc "Run RuboCop style checks"
  task :check do
    puts "Running RuboCop..."
    sh "bundle exec rubocop" rescue nil
  end

  desc "Auto-fix RuboCop violations"
  task :fix do
    puts "Auto-fixing RuboCop violations..."
    sh "bundle exec rubocop -a" rescue nil
  end
end

# ============================================================================
# Test Tasks
# ============================================================================
require 'rake/testtask'

Rake::TestTask.new(:test) do |t|
  t.libs << 'test'
  t.test_files = FileList['test/*_test.rb']
  t.verbose = true
  t.warning = false
end

desc "Run all tests"
task :test_all => :test

desc "Run model tests only"
Rake::TestTask.new(:test_models) do |t|
  t.libs << 'test'
  t.test_files = FileList['test/models_test.rb']
  t.verbose = true
end

desc "Run upload tests only"
Rake::TestTask.new(:test_upload) do |t|
  t.libs << 'test'
  t.test_files = FileList['test/upload_test.rb']
  t.verbose = true
end

desc "Run route/integration tests only"
Rake::TestTask.new(:test_routes) do |t|
  t.libs << 'test'
  t.test_files = FileList['test/routes_test.rb']
  t.verbose = true
end

namespace :test do
  desc "Run tests with coverage report"
  task :coverage do
    ENV['COVERAGE'] = 'true'
    Rake::Task[:test].invoke
  end

  desc "Clean test database"
  task :clean do
    require_relative 'config_test'
    require_relative 'model'
    puts "Cleaning test database..."
    Document.delete_all
    puts "Test database cleaned!"
  end
end

# ============================================================================
# Default Task
# ============================================================================
desc "Run tests, security audit, and code quality checks"
task default: [:test, 'deps:audit', 'lint:check']
